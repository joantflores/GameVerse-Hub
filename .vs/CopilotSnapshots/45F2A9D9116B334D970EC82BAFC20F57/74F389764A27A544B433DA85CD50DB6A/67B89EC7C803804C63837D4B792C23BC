import fetch from "node-fetch";

export async function sendWelcomeEmail(toEmail, toName) {
  const apiKey = process.env.SENDGRID_API_KEY;
  const from = process.env.EMAIL_FROM || "GameVerse Hub <no-reply@example.com>";

  if (!apiKey) {
    throw new Error("SendGrid API key not configured");
  }

  const body = {
    personalizations: [
      {
        to: [{ email: toEmail, name: toName }],
        subject: "Welcome to GameVerse Hub"
      }
    ],
    from: {
      email: from.split("<")[1]?.replace(">", "") || "no-reply@example.com",
      name: from.split("<")[0].trim() || "GameVerse Hub"
    },
    content: [
      {
        type: "text/plain",
        value: `Hello ${toName || ''},\n\nWelcome to GameVerse Hub! We're glad to have you. Explore games, play trivia and have fun!\n\n— The GameVerse Hub Team`
      }
    ]
  };

  const res = await fetch("https://api.sendgrid.com/v3/mail/send", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${apiKey}`,
      "Content-Type": "application/json"
    },
    body: JSON.stringify(body)
  });

  if (!res.ok) {
    const text = await res.text();
    throw new Error(`SendGrid error: ${res.status} ${res.statusText} - ${text}`);
  }

  return true;
}
