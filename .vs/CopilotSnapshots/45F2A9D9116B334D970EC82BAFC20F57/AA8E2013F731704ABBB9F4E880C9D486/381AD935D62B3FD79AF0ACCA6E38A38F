import { useEffect, useState } from "react";
import { Link } from "react-router-dom";
import { useAuth } from "../contexts/AuthContext";
import { obtenerHistorialBusquedas, obtenerHistorialTrivia, obtenerFavoritos } from "../services/firestoreService";
import { Timestamp } from "firebase/firestore";

export default function Dashboard() {
    const { usuario, userData } = useAuth();
    const [historialBusquedas, setHistorialBusquedas] = useState([]);
    const [historialTrivia, setHistorialTrivia] = useState([]);
    const [favoritos, setFavoritos] = useState([]);
    const [cargando, setCargando] = useState(true);

    useEffect(() => {
        if (usuario) {
            cargarDatos();
        } else {
            setCargando(false);
        }
    }, [usuario]);

    const cargarDatos = async () => {
        if (!usuario) return;
        setCargando(true);

        try {
            const [busquedasResult, triviaResult, favoritosResult] = await Promise.all([
                obtenerHistorialBusquedas(usuario.uid),
                obtenerHistorialTrivia(usuario.uid),
                obtenerFavoritos(usuario.uid)
            ]);

            if (busquedasResult.success) {
                setHistorialBusquedas(busquedasResult.historial.slice(0, 5));
            }
            if (triviaResult.success) {
                setHistorialTrivia(triviaResult.historial.slice(0, 5));
            }
            if (favoritosResult.success) {
                setFavoritos(favoritosResult.favoritos.slice(0, 6));
            }
        } catch (err) {
            console.error("Error loading dashboard data:", err);
        } finally {
            setCargando(false);
        }
    };

    const formatearFecha = (timestamp) => {
        if (!timestamp) return "";
        if (timestamp instanceof Timestamp) {
            return timestamp.toDate().toLocaleDateString("en-US");
        }
        if (timestamp.seconds) {
            return new Date(timestamp.seconds * 1000).toLocaleDateString("en-US");
        }
        return new Date(timestamp).toLocaleDateString("en-US");
    };

    if (!usuario) {
        return (
            <div className="container mt-4">
                <div className="row justify-content-center">
                    <div className="col-md-8">
                        <div className="text-center py-5">
                            <h1 className="display-4 mb-4">🎮 GameVerse Hub</h1>
                            <p className="lead mb-4">
                                Your central hub for everything about video games. Explore catalogs,
                                play trivia and discover your favorite games.
                            </p>
                            <div className="row g-3 mt-4 justify-content-center">
                                <div className="col-md-5">
                                    <div className="card h-100">
                                        <div className="card-body text-center">
                                            <h3>🎯 Catalog</h3>
                                            <p>Explore thousands of games with advanced search and filters</p>
                                            <Link to="/catalogo" className="btn btn-primary">
                                                Browse Catalog
                                            </Link>
                                        </div>
                                    </div>
                                </div>
                                <div className="col-md-5">
                                    <div className="card h-100">
                                        <div className="card-body text-center">
                                            <h3>🎲 Trivia</h3>
                                            <p>Test your knowledge about video games</p>
                                            <Link to="/trivia" className="btn btn-primary">
                                                Play Trivia
                                            </Link>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div className="mt-5">
                                <p className="text-muted">
                                    <Link to="/login">Sign in</Link> or{" "}
                                    <Link to="/registro">sign up</Link> to save your favorites
                                    and view your activity history.
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        );
    }

    if (cargando) {
        return (
            <div className="container mt-4 text-center">
                <div className="spinner-border" role="status">
                    <span className="visually-hidden">Loading...</span>
                </div>
            </div>
        );
    }

    const mejorPuntajeTrivia = historialTrivia.length > 0 
        ? Math.max(...historialTrivia.map(t => t.puntaje || 0))
        : 0;

    return (
        <div className="container mt-4">
            <div className="row mb-4">
                <div className="col-12">
                    <h1>👋 Hello, {userData?.displayName || usuario.email}!</h1>
                    <p className="text-muted">Welcome to your Dashboard</p>
                </div>
            </div>

            {/* Quick stats */}
            <div className="row mb-4">
                <div className="col-md-4 mb-3">
                    <div className="card text-center">
                        <div className="card-body">
                            <h2 className="display-4">{favoritos.length}</h2>
                            <p className="card-text">⭐ Favorite Games</p>
                            <Link to="/favoritos" className="btn btn-sm btn-outline-primary">
                                View All
                            </Link>
                        </div>
                    </div>
                </div>
                <div className="col-md-4 mb-3">
                    <div className="card text-center">
                        <div className="card-body">
                            <h2 className="display-4">{historialTrivia.length}</h2>
                            <p className="card-text">🎲 Trivia Games Played</p>
                            {mejorPuntajeTrivia > 0 && (
                                <small className="text-muted">
                                    Best score: {mejorPuntajeTrivia}
                                </small>
                            )}
                        </div>
                    </div>
                </div>
                <div className="col-md-4 mb-3">
                    <div className="card text-center">
                        <div className="card-body">
                            <h2 className="display-4">{historialBusquedas.length}</h2>
                            <p className="card-text">🔍 Recent Searches</p>
                        </div>
                    </div>
                </div>
            </div>

            <div className="row">
                {/* Recent favorites */}
                <div className="col-md-6 mb-4">
                    <div className="card">
                        <div className="card-header d-flex justify-content-between align-items-center">
                            <h5 className="mb-0">⭐ Recent Favorites</h5>
                            <Link to="/favoritos" className="btn btn-sm btn-outline-primary">
                                View All
                            </Link>
                        </div>
                        <div className="card-body">
                            {favoritos.length === 0 ? (
                                <p className="text-muted">
                                    You don't have favorites yet.{" "}
                                    <Link to="/catalogo">Explore the catalog</Link> to add some.
                                </p>
                            ) : (
                                <div className="row g-2">
                                    {favoritos.map((juego) => (
                                        <div key={juego.id} className="col-6">
                                            <Link 
                                                to={`/juego/${juego.id}`}
                                                className="text-decoration-none"
                                            >
                                                <div className="card h-100">
                                                    {juego.cover?.url && (
                                                        <img
                                                            src={juego.cover.url.replace("t_thumb", "t_cover_small")}
                                                            className="card-img-top"
                                                            alt={juego.name}
                                                            style={{ height: "100px", objectFit: "cover" }}
                                                        />
                                                    )}
                                                    <div className="card-body p-2">
                                                        <h6 className="card-title small mb-0 text-truncate">
                                                            {juego.name}
                                                        </h6>
                                                    </div>
                                                </div>
                                            </Link>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>

                {/* Trivia history */}
                <div className="col-md-6 mb-4">
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">🎲 Trivia History</h5>
                        </div>
                        <div className="card-body">
                            {historialTrivia.length === 0 ? (
                                <p className="text-muted">
                                    You haven't played trivia yet.{" "}
                                    <Link to="/trivia">Play your first game!</Link>
                                </p>
                            ) : (
                                <div className="list-group list-group-flush">
                                    {historialTrivia.map((resultado, index) => (
                                        <div key={index} className="list-group-item px-0">
                                            <div className="d-flex justify-content-between align-items-center">
                                                <div>
                                                    <strong>
                                                        {resultado.puntaje || 0} / {resultado.totalPreguntas || 0}
                                                    </strong>
                                                    <span className="badge bg-info ms-2">
                                                        {resultado.porcentaje?.toFixed(0) || 0}%
                                                    </span>
                                                </div>
                                                <small className="text-muted">
                                                    {formatearFecha(resultado.fecha)}
                                                </small>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                            <div className="mt-3 text-center">
                                <Link to="/trivia" className="btn btn-primary btn-sm">
                                    Play Trivia
                                </Link>
                            </div>
                        </div>
                    </div>
                </div>

                {/* Recent searches */}
                <div className="col-md-12 mb-4">
                    <div className="card">
                        <div className="card-header">
                            <h5 className="mb-0">🔍 Recent Searches</h5>
                        </div>
                        <div className="card-body">
                            {historialBusquedas.length === 0 ? (
                                <p className="text-muted">
                                    You haven't made any searches yet.{" "}
                                    <Link to="/catalogo">Search for your favorite game</Link>
                                </p>
                            ) : (
                                <div className="d-flex flex-wrap gap-2">
                                    {historialBusquedas.map((item, index) => (
                                        <Link
                                            key={index}
                                            to={`/catalogo?q=${encodeURIComponent(item.busqueda)}`}
                                            className="badge bg-secondary p-2 text-decoration-none"
                                        >
                                            {item.busqueda}
                                        </Link>
                                    ))}
                                </div>
                            )}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    );
}

